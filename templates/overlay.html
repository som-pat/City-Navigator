<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Interface</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <link rel="stylesheet" href="static/overlay_styles.css">
</head>
<body>
    <div id="map">
        <div id="overlay" class="overlay-container">
            <div class="overlay-content">
            <form method="POST" action="/searchRoute" id="route-form">
                <input type="text" id="start_point" name="start_point" placeholder="Starting Point">
                <input type="text" id="end_point" name="end_point" placeholder="Ending Point">
                <select id="transport_type" name="transport_type" onchange="resetAwesomplete()">
                    <option value="" disabled selected>Select</option>
                    <option value="multimodal">Multimodal</option>
                    <option value="Metro">Metro</option>
                    <option value="Bus">Bus</option>
                    <option value="walking">Walking</option>
                </select>
                <input type="submit" value="Search route" class="btn btn-primary">
            </form>
            <!-- Transport buttons -->
              
        </div>
    </div>
</div>

    <script>
        // Initialize the map
        var map = L.map('map',{
            zoomControl:false
        }).setView([28.7041, 77.1025],13); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        
       var startMarker, endMarker;
       function addMarkers(startLat, startLon, endLat, endLon){
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);

        startMarker = L.marker([startLat, startLng], {icon: L.icon({iconUrl: 'start-icon.png', iconSize: [32, 32]})}).addTo(map).bindPopup('Start');
        endMarker = L.marker([endLat, endLng], {icon: L.icon({iconUrl: 'end-icon.png', iconSize: [32, 32]})}).addTo(map).bindPopup('End');

        // Focus the map on the markers
        var bounds = L.latLngBounds([[startLat, startLng], [endLat, endLng]]);
        map.fitBounds(bounds);

       }

       function updateMarkers() {
            const startStopName = document.getElementById('start_point').value;
            const endStopName = document.getElementById('end_point').value;

            // Fetch coordinates from backend based on selected stop names
            fetch(`/api/getCoordinates?start=${startStopName}&end=${endStopName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.start && data.end) {
                        addMarkers(data.start.lat, data.start.lng, data.end.lat, data.end.lng);
                    }
                })
                .catch(error => {
                    console.error("Error fetching coordinates:", error);
                });
        }

        var awesompleteStart, awesompleteEnd;

        function resetAwesomplete() {
            const transportType = document.getElementById('transport_type').value;
            const startPointInput = document.getElementById('start_point');
            const endPointInput = document.getElementById('end_point');

            if (awesompleteStart) {
                awesompleteStart.destroy();
            }
            if (awesompleteEnd) {
                awesompleteEnd.destroy();
            }

            awesompleteStart = new Awesomplete(startPointInput, {
                minChars: 1,
                maxItems: 10,
                autoFirst: true
            });
            awesompleteEnd = new Awesomplete(endPointInput, {
                minChars: 1,
                maxItems: 10,
                autoFirst: true
            });

            //update searches
            startPointInput.addEventListener('input', function() {
                fetchStops(transportType, startPointInput.value, awesompleteStart);
            });

            endPointInput.addEventListener('input', function() {
                fetchStops(transportType, endPointInput.value, awesompleteEnd);
            });

            // Update markers when the start point is selected
            startPointInput.addEventListener('awesomplete-selectcomplete', function() {
                updateMarkers();
            });

            endPointInput.addEventListener('awesomplete-selectcomplete', function() {
                updateMarkers(); 
            });
        }

        function fetchStops(transportType, query, awesompleteInstance) {
            if (query.length < 1) return;

            fetch(`/api/getStops?Type=${transportType}&query=${query}`)
                .then(response => response.json())
                .then(data => {
                    if (data.stops) {
                        awesompleteInstance.list = data.stops;
                    }
                })
                .catch(error => {
                    console.error("Error fetching stops:", error);
                });
        }
        map.on('zoomend', function() {
            var zoomLevel = map.getZoom();
            var inputs = document.querySelector('.overlay-container');
            if (zoomLevel < 12) {
                inputs.style.display = 'none';
            } else {
                inputs.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
