<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Interface</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <link rel="stylesheet" href="static/overlay_styles.css">
</head>

<body>
    <div id="map">

        <div id="overlay" class="overlay-container" >
            <div class="overlay-content">
            <form method="POST"  id="route-form" onsubmit="return showRouteSummary(event); ">
                <input type="text" id="start_point" name="start_point" placeholder="Starting Point" onchange="updateMarkers()">
                <input type="text" id="end_point" name="end_point" placeholder="Ending Point" onchange="updateMarkers()">
                <select id="transport_type" name="transport_type" onchange="resetAwesomplete()">
                    <option value="" disabled selected>Select</option>
                    <option value="multimodal">Multimodal</option>
                    <option value="Metro">Metro</option>
                    <option value="Bus">Bus</option>
                    <option value="walking">Walking</option>
                </select>
                <input type="submit" value="Search route" class="btn btn-primary">
            </form>
            <!-- Transport buttons -->
              
        </div>
    </div>
    
    
</div>
<div id="route-summary" class="route-summary d-none">
    <div class="route-summary-header">
        <span>Route Summary</span>
        <button class="close-btn" onclick="closeRouteSummary()">X</button>
    </div>
    <div class="route-summary-content">
        <!-- Route details will be dynamically populated here -->
    </div>
</div>

 

    <script>

        // Initialize the map
        var map = L.map('map',{
            zoomControl:false
        }).setView([28.7041, 77.1025],12); 

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        
        var startMarker, endMarker;
        // Function to add markers for start and end points
        function addMarkers(startLat, startLng, endLat, endLng) {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);

            startMarker = L.marker([startLat, startLng], {icon: L.icon({iconUrl: 'icons/start_icon.png', iconSize: [32, 32]})}).addTo(map).bindPopup('Start');
            endMarker = L.marker([endLat, endLng], {icon: L.icon({iconUrl: 'icons/end_icon.png', iconSize: [32, 32]})}).addTo(map).bindPopup('End');

            // Focus the map on the markers
            var bounds = L.latLngBounds([[startLat, startLng], [endLat, endLng]]);
            map.fitBounds(bounds);
        }

        
        
        var startMarker, endMarker, routeLayer;

        function updateMarkers() {
            var startStopName = document.getElementById('start_point').value;
            var endStopName = document.getElementById('end_point').value;

            // Fetch coordinates from backend based on selected stop names
            fetch(`/api/getCoordinates?start=${startStopName}&end=${endStopName}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.start && data.end) {
                        addMarkers(data.start.lat, data.start.lng, data.end.lat, data.end.lng);          
                    }}                     
                    
                )
                .catch(error => {
                    console.error("Error fetching coordinates:", error);
                });
        }

        var awesompleteStart, awesompleteEnd;

        function resetAwesomplete() {
            const transportType = document.getElementById('transport_type').value;
            const startPointInput = document.getElementById('start_point');
            const endPointInput = document.getElementById('end_point');

            if (awesompleteStart) {
                awesompleteStart.destroy();
            }
            if (awesompleteEnd) {
                awesompleteEnd.destroy();
            }

            awesompleteStart = new Awesomplete(startPointInput, {
                minChars: 1,
                maxItems: 10,
                autoFirst: true
            });
            awesompleteEnd = new Awesomplete(endPointInput, {
                minChars: 1,
                maxItems: 10,
                autoFirst: true
            });

            //update searches
            startPointInput.addEventListener('input', function() {
                fetchStops(transportType, startPointInput.value, awesompleteStart);
            });

            endPointInput.addEventListener('input', function() {
                fetchStops(transportType, endPointInput.value, awesompleteEnd);
            });

        }

        function fetchStops(transportType, query, awesompleteInstance) {
            if (query.length < 1) return;

            fetch(`/api/getStops?Type=${transportType}&query=${query}`)
                .then(response => response.json())
                .then(data => {
                    if (data.stops) {
                        awesompleteInstance.list = data.stops;
                    }
                })
                .catch(error => {
                    console.error("Error fetching stops:", error);
                });
        }
        
        
        // commmunicator funcn to backend
        function showRouteSummary(event) {
            event.preventDefault();
            var formelement = document.getElementById('route-form')
            var data = new FormData(formelement);            
           

            fetch('/api/getRouteSummary',{
                method: 'POST',
                body: data,

            })
            .then(response => response.json())
            .then(data => {
                populateRouteSummary(data.route_summary, data.dist, data.time);
                drawRouteOnMap(data.path); // Draw the route on the map
                document.getElementById('route-summary').classList.remove('d-none');
            })
                .catch(error => {
                    console.error("Error fetching route summary:", error);
                });
        }
        

        // Populate the route summary container
        function populateRouteSummary(routeSummary, totalDistance, totalTime) {
            var summaryContainer = document.querySelector('.route-summary-content');
            summaryContainer.innerHTML = `<h4>Distance: ${totalDistance.toFixed(2)} km</h4>
                                        <h4>Time: ${totalTime}</h4>`;
            
            routeSummary.forEach(stop => {
                var stopElement = document.createElement('div');
                stopElement.classList.add('stop-summary');
                stopElement.innerHTML = `
                    <span>${stop.name} - ${stop.time}</span>
                    <span style="background-color: ${stop.route_col}; padding: 5px; border-radius: 5px;">Route Color</span>
                `;
                summaryContainer.appendChild(stopElement);
            });
        }

        // Draw the route on the map
        function drawRouteOnMap(path) {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }

            var latLngs=[]
            path.forEach(function(path){
                latLngs.push(path.geopoints);
            })
            path.forEach(function(p){
                stops = String(p.stop_name)
                var marker = L.circleMarker([p.stop_lat,p.stop_lon],{
                    color: 'blue',
                    radius: 8
                }).addTo(map)
                .bindPopup(stops)                

            })            
            
            routeLayer = L.polyline(latLngs, {color: 'red', weight: 4}).addTo(map);            
            map.fitBounds(routeLayer.getBounds());
        }

       

        // function showRouteOnMap(routeId) {
        //     // Logic to fetch and display the specific route on the map
        //     routechecker.forEach(function(layer) {
        //         map.removeLayer(layer);
        //     });
        //     routechecker = [];
        //     var latlngs = [];
        //     path.forEach(function(coords) {
        //         latlngs.push([coords[0], coords[1]]);
        //     });
        //     var polyline = L.polyline(latlngs, {color: 'red', weight: 4}).addTo(map);
        //     routechecker.push(polyline);
        // }
        

        // function closeRouteSummary(){
        //     document.getElementById('route-summary').classList.add('d-none');
        // }


        map.on('zoomend', function() {
            var zoomLevel = map.getZoom();
            var inputs = document.querySelector('.overlay-container');
            if (zoomLevel < 12) {
                inputs.style.display = 'none';
            } else {
                inputs.style.display = 'flex';
            }
        });

       
    </script>
</body>
</html>
